<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™¯é»åœ°åœ– | å£½è±å°‹å¯¶å·´å£«</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="i18n.js"></script>
</head>
<body class="game-home">

    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <div class="nav-brand-icon">
                    <i class="fas fa-map"></i>
                </div>
                <span data-i18n="map.title">æ™¯é»åœ°åœ–</span>
            </div>
            <!-- èªè¨€åˆ‡æ›å™¨ -->
            <div class="language-switcher">
                <button id="languageBtn">ğŸŒ <span id="currentFlag">ğŸ‡¹ğŸ‡¼</span></button>
                <div id="languageDropdown" class="dropdown-menu">
                    <div class="language-option" data-lang="zh-TW">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</div>
                    <div class="language-option" data-lang="en">ğŸ‡ºğŸ‡¸ English</div>
                    <div class="language-option" data-lang="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ç¯©é¸æ¨™ç±¤ -->
    <div style="background: white; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div class="container">
            <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px;">
                <button class="filter-tag active" data-filter="all" onclick="filterSpots('all')">
                    <i class="fas fa-globe"></i> <span data-i18n="filter.all">å…¨éƒ¨</span>
                </button>
                <button class="filter-tag" data-filter="nature" onclick="filterSpots('nature')">
                    <i class="fas fa-leaf"></i> <span data-i18n="route.nature">è‡ªç„¶ç”Ÿæ…‹</span>
                </button>
                <button class="filter-tag" data-filter="culture" onclick="filterSpots('culture')">
                    <i class="fas fa-torii-gate"></i> <span data-i18n="route.culture">æ–‡åŒ–é«”é©—</span>
                </button>
                <button class="filter-tag" data-filter="special" onclick="filterSpots('special')">
                    <i class="fas fa-star"></i> <span data-i18n="route.special">ç‰¹è‰²é«”é©—</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ™¯é»åˆ—è¡¨ -->
    <section style="padding: 20px 16px 100px;">
        <div class="container">
            <div id="spotsList" class="spots-list-grid">
                <!-- æ™¯é»å¡ç‰‡å°‡ç”± JavaScript ç”Ÿæˆ -->
            </div>
        </div>
    </section>

   <!-- åº•éƒ¨å°èˆª -->
	<nav class="bottom-nav">
		<div class="bottom-nav-container">
			<a href="game-home.html" class="nav-item active">
				<div class="nav-item-icon">
					<i class="fas fa-home"></i>
				</div>
				<span class="nav-item-label" data-i18n="nav.home">ä¸»é </span>
			</a>
			<a href="map.html" class="nav-item">
				<div class="nav-item-icon">
					<i class="fas fa-map"></i>
				</div>
				<span class="nav-item-label" data-i18n="nav.map">åœ°åœ–</span>
			</a>
			<a href="collection.html" class="nav-item">
				<div class="nav-item-icon">
					<i class="fas fa-book"></i>
				</div>
				<span class="nav-item-label" data-i18n="nav.collection">æ”¶è—</span>
			</a>
			<a href="profile.html" class="nav-item">
				<div class="nav-item-icon">
					<i class="fas fa-user"></i>
				</div>
				<span class="nav-item-label" data-i18n="nav.profile">å€‹äºº</span>
			</a>
			<a href="javascript:void(0)" class="nav-item" id="musicToggle" onclick="toggleMusic()" aria-pressed="false">
				<div class="nav-item-icon">
					<i id="musicToggleIcon" class="fas fa-volume-mute"></i>
				</div>
				<span class="nav-item-label" id="musicToggleLabel" data-i18n="music.turnOn">é–‹å•ŸéŸ³æ¨‚</span>
			</a>
				<!-- èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å™¨ï¼ˆéš±è—ï¼‰ -->
			   <div id="bgPlayer"></div>
			   <!-- å¼•ç”¨éŸ³æ¨‚æ§åˆ¶ JS -->
			   <script src="bg-music.js"></script>    
		</div>
	</nav>

    <script src="spots-data.js"></script>
    <script src="spots-i18n.js"></script>
    <script>
        // è¼‰å…¥æ”¶è—è¨˜éŒ„
        const collection = JSON.parse(localStorage.getItem('collection')) || [];
        let currentFilter = 'all';
        let currentLanguage = 'zh-TW';

        // ç”Ÿæˆæ™¯é»åˆ—è¡¨ï¼ˆæ”¯æ´å¤šèªè¨€ï¼‰
        function renderSpots(filter = 'all') {
            const spotsList = document.getElementById('spotsList');
            
            // å–å¾—ç•¶å‰èªè¨€
            currentLanguage = i18n.getCurrentLanguage();
            
            // å–å¾—å¤šèªè¨€ç‰ˆæœ¬çš„æ™¯é»è³‡æ–™
            const localizedSpots = getAllLocalizedSpots(currentLanguage);
            
            const filteredSpots = filter === 'all' 
                ? localizedSpots 
                : localizedSpots.filter(spot => spot.route === filter);

            spotsList.innerHTML = filteredSpots.map(spot => {
                const isCollected = collection.some(c => c.id === spot.id);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºéš±è—æ™¯é»
                const isHidden = spot.isHidden || false;
                let isUnlocked = false;
                
                // å¦‚æœæ˜¯éš±è—æ™¯é»,æª¢æŸ¥æ˜¯å¦å·²è§£é–
                if (isHidden && spot.parentId) {
                    isUnlocked = collection.some(c => c.id === spot.parentId);
                }
                
                // é¡¯ç¤ºåç¨±:æœªè§£é–éš±è—æ™¯é»é¡¯ç¤ºã€Œ??? ç¥ç§˜æ™¯é»ã€
                const displayName = (isHidden && !isUnlocked) ? spot.name : (spot.displayName || spot.name);
                
                // é¡¯ç¤ºæè¿°:æœªè§£é–éš±è—æ™¯é»é¡¯ç¤ºç‰¹æ®Šæç¤º
                const displayDesc = (isHidden && !isUnlocked) ? spot.shortDesc : spot.shortDesc;
                
                const difficultyInfo = {
                    'easy': { text: getDifficultyText('easy'), color: '#4caf50', exp: 30 },
                    'normal': { text: getDifficultyText('normal'), color: '#ff9800', exp: 50 },
                    'hard': { text: getDifficultyText('hard'), color: '#f44336', exp: 80 }
                };
                const diff = difficultyInfo[spot.difficulty];

                // éš±è—æ™¯é»ä½¿ç”¨ç‰¹æ®Šæ¨£å¼
                const hiddenClass = (isHidden && !isUnlocked) ? 'hidden-spot' : '';
                const lockedIcon = (isHidden && !isUnlocked) ? '<i class="fas fa-lock" style="margin-left: 8px; color: #ffd700;"></i>' : '';

                return `
                    <div class="spot-list-card ${isCollected ? 'collected' : ''} ${hiddenClass}" onclick="goToSpotDetail(${spot.id}, ${isHidden}, ${isUnlocked})">
                        <div class="spot-list-image" style="background: linear-gradient(135deg, ${getRouteColor(spot.route)});">
                            <i class="fas ${(isHidden && !isUnlocked) ? 'fa-question' : spot.icon} fa-3x"></i>
                            ${isCollected ? '<div class="collected-badge"><i class="fas fa-check-circle"></i></div>' : ''}
                            ${(isHidden && !isUnlocked) ? '<div class="hidden-badge">âœ¨</div>' : ''}
                        </div>
                        <div class="spot-list-content">
                            <div class="spot-list-header">
                                <h3 class="spot-list-title">${displayName}${lockedIcon}</h3>
                                <span class="difficulty-badge" style="background: ${diff.color}">
                                    ${diff.text} +${spot.exp || diff.exp} EXP
                                </span>
                            </div>
                            <p class="spot-list-desc">${displayDesc}</p>
                            <div class="spot-list-footer">
                                <div class="spot-list-info">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${getRouteLabel(spot.route)}</span>
                                </div>
                                ${isCollected 
                                    ? `<span class="collected-label"><i class="fas fa-check"></i> ${getCollectedText()}</span>`
                                    : (isHidden && !isUnlocked) 
                                        ? `<span class="locked-label"><i class="fas fa-lock"></i> ${getNeedUnlockText()}</span>`
                                        : `<span class="go-checkin">${getGoCheckinText()} <i class="fas fa-arrow-right"></i></span>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å–å¾—é›£åº¦æ–‡å­—ï¼ˆå¤šèªè¨€ï¼‰
        function getDifficultyText(difficulty) {
            const texts = {
                'zh-TW': { easy: 'ç°¡å–®', normal: 'æ™®é€š', hard: 'å›°é›£' },
                'en': { easy: 'Easy', normal: 'Normal', hard: 'Hard' },
                'ja': { easy: 'ç°¡å˜', normal: 'æ™®é€š', hard: 'å›°é›£' }
            };
            return texts[currentLanguage][difficulty] || texts['zh-TW'][difficulty];
        }

        // å–å¾—ã€Œå·²æ”¶é›†ã€æ–‡å­—ï¼ˆå¤šèªè¨€ï¼‰
        function getCollectedText() {
            const texts = {
                'zh-TW': 'å·²æ”¶é›†',
                'en': 'Collected',
                'ja': 'åé›†æ¸ˆã¿'
            };
            return texts[currentLanguage] || texts['zh-TW'];
        }

        // å–å¾—ã€Œéœ€è§£é–ã€æ–‡å­—ï¼ˆå¤šèªè¨€ï¼‰
        function getNeedUnlockText() {
            const texts = {
                'zh-TW': 'éœ€è§£é–',
                'en': 'Locked',
                'ja': 'ãƒ­ãƒƒã‚¯ä¸­'
            };
            return texts[currentLanguage] || texts['zh-TW'];
        }

        // å–å¾—ã€Œå‰å¾€æ‰“å¡ã€æ–‡å­—ï¼ˆå¤šèªè¨€ï¼‰
        function getGoCheckinText() {
            const texts = {
                'zh-TW': 'å‰å¾€æ‰“å¡',
                'en': 'Check In',
                'ja': 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³'
            };
            return texts[currentLanguage] || texts['zh-TW'];
        }

        // ç¯©é¸åŠŸèƒ½
        function filterSpots(filter) {
            currentFilter = filter;
            
            // æ›´æ–°æ¨™ç±¤æ¨£å¼
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // é‡æ–°æ¸²æŸ“
            renderSpots(filter);
        }

        // å‰å¾€æ™¯é»è©³æƒ…
        function goToSpotDetail(spotId, isHidden, isUnlocked) {
            // å¦‚æœæ˜¯æœªè§£é–çš„éš±è—æ™¯é»,é¡¯ç¤ºæç¤ºè¨Šæ¯
            if (isHidden && !isUnlocked) {
                const spot = spotsData.find(s => s.id === spotId);
                const parentSpot = spotsData.find(s => s.id === spot.parentId);
                
                const messages = {
                    'zh-TW': `ğŸ”’ é€™æ˜¯éš±è—æ™¯é»!\n\néœ€è¦å…ˆå®Œæˆã€Œ${parentSpot.name}ã€çš„æ‰“å¡æ‰èƒ½è§£é–é€™å€‹ç¥ç§˜åœ°é»å“¦!`,
                    'en': `ğŸ”’ This is a hidden spot!\n\nYou need to check in at "${parentSpot.name}" first to unlock this mysterious location!`,
                    'ja': `ğŸ”’ ã“ã‚Œã¯éš ã—ã‚¹ãƒãƒƒãƒˆã§ã™!\n\nã€Œ${parentSpot.name}ã€ã§ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ã€ã“ã®ç¥ç§˜çš„ãªå ´æ‰€ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„!`
                };
                
                alert(messages[currentLanguage] || messages['zh-TW']);
                return;
            }
            window.location.href = `spot-detail.html?id=${spotId}`;
        }

        // å–å¾—è·¯ç·šé¡è‰²
        function getRouteColor(route) {
            const colors = {
                'nature': '#66bb6a 0%, #43a047 100%',
                'culture': '#ffa726 0%, #fb8c00 100%',
                'special': '#42a5f5 0%, #1e88e5 100%'
            };
            return colors[route] || '#7cb342 0%, #aed581 100%';
        }

        // å–å¾—è·¯ç·šæ¨™ç±¤ï¼ˆå¤šèªè¨€ï¼‰
        function getRouteLabel(route) {
            const labels = {
                'zh-TW': {
                    'nature': 'è‡ªç„¶ç”Ÿæ…‹',
                    'culture': 'æ–‡åŒ–é«”é©—',
                    'special': 'ç‰¹è‰²é«”é©—'
                },
                'en': {
                    'nature': 'Nature',
                    'culture': 'Culture',
                    'special': 'Special'
                },
                'ja': {
                    'nature': 'è‡ªç„¶ç”Ÿæ…‹',
                    'culture': 'æ–‡åŒ–ä½“é¨“',
                    'special': 'ç‰¹è‰²ä½“é¨“'
                }
            };
            return labels[currentLanguage][route] || labels['zh-TW'][route] || 'æ™¯é»';
        }

        // å¾ URL è®€å–è·¯ç·šåƒæ•¸ä¸¦åˆå§‹åŒ–
        function initializeMap() {
            const urlParams = new URLSearchParams(window.location.search);
            const routeParam = urlParams.get('route');
            
            if (routeParam && ['nature', 'culture', 'special'].includes(routeParam)) {
                // è‡ªå‹•é¸æ“‡å°æ‡‰çš„è·¯ç·šç¯©é¸å™¨
                filterSpots(routeParam);
            } else {
                // æ²’æœ‰åƒæ•¸å‰‡é¡¯ç¤ºå…¨éƒ¨
                renderSpots();
            }
        }

        // åˆå§‹åŒ–
        initializeMap();
    
        // èªè¨€åˆ‡æ›å™¨åŠŸèƒ½
        const languageBtn = document.getElementById('languageBtn');
        const languageDropdown = document.getElementById('languageDropdown');
        const currentFlag = document.getElementById('currentFlag');
        const languageOptions = document.querySelectorAll('.language-option');
        const languageFlags = {'zh-TW': 'ğŸ‡¹ğŸ‡¼', 'en': 'ğŸ‡ºğŸ‡¸', 'ja': 'ğŸ‡¯ğŸ‡µ'};
        
        if (languageBtn) {
            languageBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                languageDropdown.classList.toggle('show');
            });
            document.addEventListener('click', () => languageDropdown.classList.remove('show'));
        }
        
        languageOptions.forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                const lang = option.getAttribute('data-lang');
                i18n.setLanguage(lang);
                currentFlag.textContent = languageFlags[lang];
                languageOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                languageDropdown.classList.remove('show');
                
                // åˆ‡æ›èªè¨€å¾Œé‡æ–°æ¸²æŸ“æ™¯é»åˆ—è¡¨
                renderSpots(currentFilter);
            });
        });
        
        const currentLang = i18n.getCurrentLanguage();
        currentFlag.textContent = languageFlags[currentLang];
        languageOptions.forEach(option => {
            if (option.getAttribute('data-lang') === currentLang) option.classList.add('active');
        });
    </script>
</body>
</html>
