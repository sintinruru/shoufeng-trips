<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™¯é»æ‰“å¡ | å£½è±å°‹å¯¶å·´</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="i18n.js"></script>
</head>
<body class="spot-detail-page">
   <!-- èªè¨€åˆ‡æ›å™¨ -->
            <div class="language-switcher">
                <button id="languageBtn">ğŸŒ <span id="currentFlag">ğŸ‡¹ğŸ‡¼</span></button>
                <div id="languageDropdown" class="dropdown-menu">
                    <div class="language-option" data-lang="zh-TW">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</div>
                    <div class="language-option" data-lang="en">ğŸ‡ºğŸ‡¸ English</div>
                    <div class="language-option" data-lang="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</div>
                </div>
            </div>

    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container">
            <button class="nav-icon-btn" onclick="history.back()" style="margin-right: auto;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="nav-brand">
                <span data-i18n="checkin.title">æ™¯é»æ‰“å¡</span>
            </div>
            <div style="width: 40px;"></div>
        </div>
    </nav>

    <!-- æ™¯é»è³‡è¨Š -->
    <div class="checkin-spot-info">
        <div class="checkin-spot-icon" id="checkinIcon">
            <i class="fas fa-mountain"></i>
        </div>
        <h2 class="checkin-spot-name" id="checkinSpotName">æ™¯é»åç¨±</h2>
        <p class="checkin-spot-desc" id="checkinSpotDesc">æ™¯é»æè¿°</p>
    </div>

    <!-- æ‰“å¡æ–¹å¼é¸æ“‡ -->
    <div class="checkin-methods">
        <div class="container">
            <h3 class="methods-title" data-i18n="checkin.selectMethod">é¸æ“‡æ‰“å¡æ–¹å¼</h3>
            
            <!-- QR Code æƒæ -->
            <div class="method-card">
                <div class="method-icon">
                    <i class="fas fa-qrcode"></i>
                </div>
                <div class="method-content">
                    <h4 data-i18n="checkin.scan">æƒæ QR Code</h4>
                    <p data-i18n="checkin.scanDesc">åˆ°é”æ™¯é»å¾Œæƒæç¾å ´çš„ QR Code</p>
                </div>
                <button class="method-btn" onclick="startQRScan()">
                    <i class="fas fa-camera"></i>
                    <span data-i18n="checkin.startScan">é–‹å§‹æƒæ</span>
                </button>
            </div>

            <!-- æ¨¡æ“¬æ‰“å¡ -->
            <div class="method-card">
                <div class="method-icon" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);">
                    <i class="fas fa-vial"></i>
                </div>
                <div class="method-content">
                    <h4 data-i18n="checkin.simulate">æ¨¡æ“¬æ‰“å¡</h4>
                    <p data-i18n="checkin.simulateDesc">é–‹ç™¼æ¸¬è©¦ç”¨,ç›´æ¥è§£é–æ™¯é»</p>
                </div>
                <button class="method-btn" style="background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);" onclick="simulateCheckin()">
                    <i class="fas fa-bolt"></i>
                    <span data-i18n="checkin.simulateBtn">æ¨¡æ“¬æ‰“å¡</span>
                </button>
            </div>
        </div>
    </div>

    <!-- QR æƒæå€(é è¨­éš±è—) -->
    <div class="qr-scanner-container" id="qrScanner" style="display: none;">
        <div class="qr-scanner-header">
            <button class="qr-close-btn" onclick="closeQRScan()">
                <i class="fas fa-times"></i>
            </button>
            <h3 data-i18n="checkin.scan">æƒæ QR Code</h3>
        </div>
        <div class="qr-reader-wrapper">
            <div id="qr-reader"></div>
        </div>
        <div class="qr-scanner-hint">
            <i class="fas fa-info-circle"></i>
            <span data-i18n="checkin.scanHint">å°‡ QR Code å°æº–æ¡†å…§å³å¯è‡ªå‹•æƒæ</span>
        </div>
        <div class="qr-scanner-help">
            <p><strong data-i18n="checkin.noQRCode">æ‰¾ä¸åˆ° QR Code?</strong></p>
            <p data-i18n="checkin.noQRCodeDesc">è«‹ç¢ºèªæ™¯é»æ˜¯å¦å·²è¨­ç½® QR Code æ¨™ç¤ºç‰Œ</p>
            <button class="help-btn" onclick="closeQRScan()">
                <span data-i18n="checkin.useSimulate">ä½¿ç”¨æ¨¡æ“¬æ‰“å¡</span>
            </button>
        </div>
    </div>

    <!-- æˆåŠŸå‹•ç•«(é è¨­éš±è—) -->
    <div class="success-modal" id="successModal" style="display: none;">
        <div class="success-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="success-title" data-i18n="checkin.success">æ”¶é›†æˆåŠŸ!</h2>
            <p class="success-message">
                <span data-i18n="checkin.congrats">æ­å–œä½ æ”¶é›†äº†</span> <strong id="successSpotName"></strong>
            </p>
            <div class="success-reward">
                <div class="reward-item">
                    <i class="fas fa-star"></i>
                    <span>+<span id="successExp">50</span> EXP</span>
                </div>
                <div class="reward-item" id="levelUpReward" style="display: none;">
                    <i class="fas fa-arrow-up"></i>
                    <span><span data-i18n="checkin.levelUpTo">å‡ç´šåˆ°</span> Level <span id="newLevel">2</span>!</span>
                </div>
            </div>
            <button class="success-btn" onclick="closeSuccess()">
                <i class="fas fa-book"></i>
                <span data-i18n="checkin.viewCollection">æŸ¥çœ‹æ”¶è—</span>
            </button>
            <button class="success-btn-secondary" onclick="backToMap()">
                <span data-i18n="checkin.continue">ç¹¼çºŒæ¢ç´¢</span>
            </button>
        </div>
    </div>

    <script src="spots-data.js"></script>
    <script src="spots-i18n.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        // ç•¶å‰èªè¨€
        let currentLanguage = i18n.getCurrentLanguage();
        
        // å¾ URL å–å¾—æ™¯é» ID
        const urlParams = new URLSearchParams(window.location.search);
        const spotId = parseInt(urlParams.get('id'));
        
        // å–å¾—æ™¯é»è³‡æ–™ï¼ˆå¤šèªè¨€ç‰ˆæœ¬ï¼‰
        let spot = getLocalizedSpot(spotId, currentLanguage);
        
        if (!spot) {
            alert(i18n.t('checkin.spotNotFound'));
            window.location.href = 'map.html';
        }

        // æª¢æŸ¥æ˜¯å¦å·²æ”¶é›†
        const collection = JSON.parse(localStorage.getItem('collection')) || [];
        if (collection.some(c => c.id === spotId)) {
            alert(i18n.t('checkin.alreadyCollected'));
            window.location.href = `spot-detail.html?id=${spotId}`;
        }

        // æ¸²æŸ“æ™¯é»è³‡è¨Š
        function renderSpotInfo() {
            spot = getLocalizedSpot(spotId, currentLanguage);
            if (!spot) return;

            document.getElementById('checkinIcon').style.background = 
                `linear-gradient(135deg, ${getRouteColor(spot.route)})`;
            document.getElementById('checkinIcon').innerHTML = `<i class="fas ${spot.icon}"></i>`;
            document.getElementById('checkinSpotName').textContent = spot.name;
            document.getElementById('checkinSpotDesc').textContent = spot.shortDesc;
        }

        // åˆå§‹åŒ–é¡¯ç¤º
        renderSpotInfo();

        // QR æƒæå™¨
        let html5QrcodeScanner = null;

        // é–‹å§‹ QR æƒæ
        function startQRScan() {
            document.getElementById('qrScanner').style.display = 'flex';
            
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader",
                { 
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
                },
                /* verbose= */ false
            );

            html5QrcodeScanner.render(onScanSuccess, onScanError);
        }

        // æƒææˆåŠŸ
        function onScanSuccess(decodedText, decodedResult) {
            console.log('æƒæåˆ°çš„å…§å®¹:', decodedText);
            
            // é©—è­‰ QR Code å…§å®¹
            // æ ¼å¼: SHOUFENG_SPOT_{æ™¯é»ID}
            const expectedCode = `SHOUFENG_SPOT_${spotId}`;
            
            if (decodedText === expectedCode) {
                // æ­£ç¢ºçš„ QR Code
                html5QrcodeScanner.clear();
                closeQRScan();
                completeCheckin('qr');
            } else if (decodedText.startsWith('SHOUFENG_SPOT_')) {
                // æ˜¯å£½è±æ™¯é»çš„ QR Code,ä½†ä¸æ˜¯é€™å€‹æ™¯é»
                const scannedId = decodedText.split('_')[2];
                const scannedSpot = spotsData.find(s => s.id == scannedId);
                const scannedSpotLocalized = getLocalizedSpot(parseInt(scannedId), currentLanguage);
                const spotName = scannedSpotLocalized ? scannedSpotLocalized.name : (scannedSpot ? scannedSpot.name : 'å…¶ä»–æ™¯é»');
                
                html5QrcodeScanner.pause();
                
                // å¤šèªè¨€æç¤ºè¨Šæ¯
                const messages = {
                    'zh-TW': `é€™æ˜¯ã€Œ${spotName}ã€çš„ QR Code!\n\nè¦æ”¹ç‚ºæ‰“å¡ã€Œ${spotName}ã€å—?`,
                    'en': `This is the QR Code for "${spotName}"!\n\nWould you like to check in at "${spotName}" instead?`,
                    'ja': `ã“ã‚Œã¯ã€Œ${spotName}ã€ã®QRã‚³ãƒ¼ãƒ‰ã§ã™ï¼\n\nã€Œ${spotName}ã€ã§ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ`
                };
                const msg = messages[currentLanguage] || messages['zh-TW'];
                
                if (confirm(msg)) {
                    window.location.href = `checkin.html?id=${scannedId}`;
                } else {
                    html5QrcodeScanner.resume();
                }
            } else {
                // ä¸æ˜¯å£½è±æ™¯é»çš„ QR Code
                alert(i18n.t('checkin.wrongQRCode'));
            }
        }

        // æƒæéŒ¯èª¤(æŒçºŒæƒææ™‚çš„æ­£å¸¸ç‹€æ…‹)
        function onScanError(error) {
            // å¿½ç•¥æŒçºŒçš„æƒæéŒ¯èª¤è¨Šæ¯
            // console.log(error);
        }

        // é—œé–‰ QR æƒæ
        function closeQRScan() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
            document.getElementById('qrScanner').style.display = 'none';
        }

        // æ¨¡æ“¬æ‰“å¡
        function simulateCheckin() {
            // å¤šèªè¨€ç¢ºèªè¨Šæ¯
            const messages = {
                'zh-TW': `ç¢ºå®šè¦æ¨¡æ“¬æ‰“å¡ã€Œ${spot.name}ã€å—?\n\nâš ï¸ é€™æ˜¯æ¸¬è©¦åŠŸèƒ½,å¯¦éš›ä½¿ç”¨æ™‚è«‹æƒæ QR Codeã€‚`,
                'en': `Are you sure you want to simulate check-in at "${spot.name}"?\n\nâš ï¸ This is a test feature, please scan QR Code for actual use.`,
                'ja': `ã€Œ${spot.name}ã€ã§æ¨¡æ“¬ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã§ã™ã€‚å®Ÿéš›ã®ä½¿ç”¨æ™‚ã¯QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚`
            };
            const msg = messages[currentLanguage] || messages['zh-TW'];
            
            if (confirm(msg)) {
                completeCheckin('simulation');
            }
        }

        // å®Œæˆæ‰“å¡
        function completeCheckin(method = 'simulation') {
            // å–å¾—ç©å®¶è³‡æ–™
            let playerData = JSON.parse(localStorage.getItem('player'));
            if (!playerData) {
                alert(i18n.t('checkin.noPlayerData'));
                window.location.href = 'create-character.html';
                return;
            }

            // åŠ å…¥æ”¶è—
            const newCollection = {
                id: spot.id,
                name: spot.name,
                collectedAt: new Date().toISOString(),
                method: method, // 'qr' or 'simulation'
                exp: spot.exp
            };
            collection.push(newCollection);
            localStorage.setItem('collection', JSON.stringify(collection));

            // å¢åŠ ç¶“é©—å€¼
            const oldLevel = playerData.level || 1;
            playerData.exp = (playerData.exp || 0) + spot.exp;

            // æª¢æŸ¥å‡ç´š
            let newLevel = oldLevel;
            for (let level in levelRequirements) {
                if (playerData.exp >= levelRequirements[level]) {
                    newLevel = parseInt(level);
                }
            }

            const leveledUp = newLevel > oldLevel;
            playerData.level = newLevel;

            // å„²å­˜ç©å®¶è³‡æ–™
            localStorage.setItem('player', JSON.stringify(playerData));

            // é¡¯ç¤ºæˆåŠŸç•«é¢
            showSuccess(spot.name, spot.exp, leveledUp, newLevel);
        }

        // é¡¯ç¤ºæˆåŠŸç•«é¢
        function showSuccess(spotName, exp, leveledUp, newLevel) {
            document.getElementById('successSpotName').textContent = spotName;
            document.getElementById('successExp').textContent = exp;
            
            if (leveledUp) {
                document.getElementById('levelUpReward').style.display = 'flex';
                document.getElementById('newLevel').textContent = newLevel;
            }

            document.getElementById('successModal').style.display = 'flex';
            
            // æ’­æ”¾éŸ³æ•ˆ(å¦‚æœæœ‰)
            // playSuccessSound();
        }

        // é—œé–‰æˆåŠŸç•«é¢
        function closeSuccess() {
            window.location.href = 'collection.html';
        }

        // è¿”å›åœ°åœ–
        function backToMap() {
            window.location.href = 'map.html';
        }

        // å–å¾—è·¯ç·šé¡è‰²
        function getRouteColor(route) {
            const colors = {
                'nature': '#66bb6a 0%, #43a047 100%',
                'culture': '#ffa726 0%, #fb8c00 100%',
                'special': '#42a5f5 0%, #1e88e5 100%'
            };
            return colors[route] || '#7cb342 0%, #aed581 100%';
        }
    
        // èªè¨€åˆ‡æ›å™¨åŠŸèƒ½
        const languageBtn = document.getElementById('languageBtn');
        const languageDropdown = document.getElementById('languageDropdown');
        const currentFlag = document.getElementById('currentFlag');
        const languageOptions = document.querySelectorAll('.language-option');
        const languageFlags = {'zh-TW': 'ğŸ‡¹ğŸ‡¼', 'en': 'ğŸ‡ºğŸ‡¸', 'ja': 'ğŸ‡¯ğŸ‡µ'};
        
        if (languageBtn) {
            languageBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                languageDropdown.classList.toggle('show');
            });
            document.addEventListener('click', () => languageDropdown.classList.remove('show'));
        }
        
        languageOptions.forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                const lang = option.getAttribute('data-lang');
                i18n.setLanguage(lang);
                currentLanguage = lang;
                currentFlag.textContent = languageFlags[lang];
                languageOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                languageDropdown.classList.remove('show');
                
                // ğŸ¯ é‡æ–°æ¸²æŸ“æ™¯é»è³‡è¨Š
                renderSpotInfo();
            });
        });
        
        const currentLang = i18n.getCurrentLanguage();
        currentFlag.textContent = languageFlags[currentLang];
        languageOptions.forEach(option => {
            if (option.getAttribute('data-lang') === currentLang) option.classList.add('active');
        });
    </script>
</body>
</html>
